version: '3'

vars:
  DIST_DIR: '{{.ROOT_DIR}}/dist'
  PKG_NAME: zakuro-ai
  INIT_FILE: '{{.ROOT_DIR}}/zakuro/__init__.py'

tasks:
  version-check:
    desc: Verify version not on PyPI
    cmds:
      - |
        VERSION=$(grep -oP '__version__\s*=\s*"\K[^"]+' {{.INIT_FILE}})
        echo "Local version: $VERSION"
        HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://pypi.org/pypi/{{.PKG_NAME}}/json")
        if [ "$HTTP_CODE" = "404" ]; then
          echo "Package not yet on PyPI - OK to publish"
          exit 0
        fi
        EXISTING=$(curl -s "https://pypi.org/pypi/{{.PKG_NAME}}/json" | python3 -c "import json,sys; print('\n'.join(json.load(sys.stdin).get('releases',{}).keys()))")
        if echo "$EXISTING" | grep -qx "$VERSION"; then
          echo "ERROR: Version $VERSION already exists on PyPI"
          exit 1
        fi
        echo "Version $VERSION not on PyPI - OK to publish"

  publish:
    desc: Build and publish to PyPI
    preconditions:
      - sh: '[ -n "$PYPI_TOKEN" ]'
        msg: "PYPI_TOKEN environment variable is required"
    cmds:
      - task build:clean
      - task build:wheel
      - uvx twine upload --username __token__ --password $PYPI_TOKEN {{.DIST_DIR}}/*.whl

  publish-test:
    desc: Publish to TestPyPI
    preconditions:
      - sh: '[ -n "$TEST_PYPI_TOKEN" ]'
        msg: "TEST_PYPI_TOKEN environment variable is required"
    cmds:
      - task build:clean
      - task build:wheel
      - uvx twine upload --repository testpypi --username __token__ --password $TEST_PYPI_TOKEN {{.DIST_DIR}}/*.whl

  pypi:
    desc: Upload to PyPI (used by CI, expects TWINE_USERNAME and TWINE_PASSWORD)
    cmds:
      - uvx twine upload {{.DIST_DIR}}/*.whl
