# Zakuro 2-Node P2P Mesh with Tailscale
#
# Each node = broker + worker + Tailscale sidecar
# PostgreSQL is provided by the dashboard stack (zak-postgres on zakuro-shared network).
# Worker and Tailscale share the broker's network namespace (same Tailscale IP).
# Discovery probes ZAKURO_PEERS via Tailscale tunnel -> finds remote workers.
# Local worker execution = free (cost=0). Remote = charged via credit ledger.
#
# Prerequisites:
#   1. Dashboard stack must be running: cd zak-dashboard && docker compose up -d
#   2. export ZK0NODE01_API_KEY=tskey-auth-...
#      export ZK0NODE02_API_KEY=tskey-auth-...
#
# Usage:
#   docker compose -f docker/docker-compose.mesh.yml up -d --build
#   docker compose -f docker/docker-compose.mesh.yml logs -f node1-broker node2-broker
#
# Verify:
#   curl http://localhost:9001/workers   # should list 2 workers
#   curl http://localhost:9002/workers   # should list 2 workers

services:
  # ============ NODE 1: standard tier ============

  node1-broker:
    build:
      context: ../../zak-zc
      dockerfile: docker/Dockerfile
    environment:
      DATABASE_URL: postgresql://zakuro_broker:broker_secret_change_me@zak-postgres:5432/zakuro
      ZAKURO_MASTER_KEY: node1-key
      ZAKURO_AUTH: node1
      ZAKURO_OWNER_ID: "1000000001"
      ZAKURO_NODE_NAME: zk0-node01
      # Tailscale peer discovery (IPs from `tailscale ip -4` on each node)
      ZAKURO_TAILSCALE_IP: ${NODE1_TAILSCALE_IP:-}
      ZAKURO_PEERS: ${NODE2_TAILSCALE_IP:-}:3960
      ZAKURO_PEER_KEY: ${ZAKURO_PEER_KEY:-zakuro-p2p-secret}
      ZAKURO_P2P: ${ZAKURO_P2P:-false}
      # Dashboard API for worker sync (preferred over direct DB access)
      ZAKURO_API_URL: ${ZAKURO_API_URL:-http://zak-api:8000}
      ZAKURO_API_KEY: ${ZAKURO_API_KEY}
    ports:
      - "9001:9000"
    networks: [node1-net, zakuro-shared]
    volumes:
      - node1-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 10s
      timeout: 70s
      start_period: 90s
      retries: 5

  node1-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    environment:
      ZAKURO_WORKER_NAME: zk0-node01-worker
      ZAKURO_WORKER_TYPE: standard
      ZAKURO_CPU_PRICE: "0.001"
      ZAKURO_MEMORY_PRICE: "0.0001"
      PYTHONUNBUFFERED: "1"
    network_mode: "service:node1-broker"
    depends_on:
      node1-broker:
        condition: service_healthy

  node1-tailscale:
    image: tailscale/tailscale:latest
    cap_add: [NET_ADMIN, NET_RAW, SYS_MODULE]
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      TS_AUTHKEY: ${ZK0NODE01_API_KEY}
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: "false"
      TS_EXTRA_ARGS: "--hostname=zk0-node01 --netfilter-mode=off --accept-dns=false"
    network_mode: "service:node1-broker"
    depends_on:
      node1-broker:
        condition: service_healthy
    volumes:
      - node1-ts:/var/lib/tailscale

  # ============ NODE 2: premium tier ============

  node2-broker:
    build:
      context: ../../zak-zc
      dockerfile: docker/Dockerfile
    environment:
      DATABASE_URL: postgresql://zakuro_broker:broker_secret_change_me@zak-postgres:5432/zakuro
      ZAKURO_MASTER_KEY: node2-key
      ZAKURO_AUTH: node2
      ZAKURO_OWNER_ID: "1000000002"
      ZAKURO_NODE_NAME: zk0-node02
      # Tailscale peer discovery (IPs from `tailscale ip -4` on each node)
      ZAKURO_TAILSCALE_IP: ${NODE2_TAILSCALE_IP:-}
      ZAKURO_PEERS: ${NODE1_TAILSCALE_IP:-}:3960
      ZAKURO_PEER_KEY: ${ZAKURO_PEER_KEY:-zakuro-p2p-secret}
      ZAKURO_P2P: ${ZAKURO_P2P:-false}
    ports:
      - "9002:9000"
    networks: [node2-net, zakuro-shared]
    volumes:
      - node2-data:/app/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9000/health"]
      interval: 10s
      timeout: 70s
      start_period: 90s
      retries: 5

  node2-worker:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    environment:
      ZAKURO_WORKER_NAME: zk0-node02-worker
      ZAKURO_WORKER_TYPE: premium
      ZAKURO_CPU_PRICE: "0.003"
      ZAKURO_MEMORY_PRICE: "0.0003"
      PYTHONUNBUFFERED: "1"
    network_mode: "service:node2-broker"
    depends_on:
      node2-broker:
        condition: service_healthy

  node2-tailscale:
    image: tailscale/tailscale:latest
    cap_add: [NET_ADMIN, NET_RAW, SYS_MODULE]
    devices:
      - /dev/net/tun:/dev/net/tun
    environment:
      TS_AUTHKEY: ${ZK0NODE02_API_KEY}
      TS_STATE_DIR: /var/lib/tailscale
      TS_USERSPACE: "false"
      TS_EXTRA_ARGS: "--hostname=zk0-node02 --netfilter-mode=off --accept-dns=false"
    network_mode: "service:node2-broker"
    depends_on:
      node2-broker:
        condition: service_healthy
    volumes:
      - node2-ts:/var/lib/tailscale

  # ============ INIT: seed credits on both nodes ============

  init:
    image: curlimages/curl:latest
    depends_on:
      node1-broker:
        condition: service_healthy
      node2-broker:
        condition: service_healthy
    networks: [node1-net, node2-net]
    volumes:
      - ./init-mesh.sh:/init-mesh.sh:ro
    entrypoint: ["/bin/sh", "/init-mesh.sh"]
    restart: "no"

  # ============ DEMO: task planner ============

  demo:
    build:
      context: ..
      dockerfile: docker/Dockerfile.demo
    networks: [node1-net, node2-net]
    profiles: ["demo"]
    restart: "no"

networks:
  node1-net:
  node2-net:
  zakuro-shared:
    external: true
    name: zakuro-shared

volumes:
  node1-data:
  node1-ts:
  node2-data:
  node2-ts:
